<script type="text/javascript" src="version.js"></script>
<script type="text/javascript">
function getSettings()
{
    return localStorage;
}

function getUrl(url, callback)
{
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function()
    {
        if (xhr.readyState == 4)
        {
            callback(xhr);
        }
    }
    xhr.open("GET", url, true);
    xhr.send();
}

function showPageAction(tabId, url)
{
    updatePageActionIcon(tabId, url);
    chrome.pageAction.show(tabId);
}

function updatePageActionIcon(tabId, url)
{
    var last_version = localStorage["version"];
    if (!last_version || last_version < CURRENT_VERSION)
    {
        chrome.pageAction.setIcon({ "tabId": tabId, "path": "shack-new.png" });
    }
    else
    {
        chrome.pageAction.setIcon({ "tabId": tabId, "path": "shack.png" });
    }
}

function updatePageActionIcons()
{
    chrome.windows.getAll({populate:true}, function(windows)
    {
        for (var i = 0; i < windows.length; i++){
            var tabs = windows[i].tabs
            for (var j = 0; j < tabs.length; j++)
                updatePageActionIcon(tabs[j].id, tabs[j].url);
        }
    });
}

function collapseThread(id)
{
    var MAX_LENGTH = 100;

    var collapsed = localStorage["collapsed_threads"];
    if (!collapsed)
        collapsed = new Array();
    else
        collapsed = JSON.parse(collapsed);

    if (collapsed.indexOf(id) < 0)
    {
        collapsed.unshift(id);

        // remove a bunch if it gets too big
        if (collapsed.length > MAX_LENGTH * 1.25)
            collapsed.splice(MAX_LENGTH);

        localStorage["collapsed_threads"] = JSON.stringify(collapsed);
    }
}

function unCollapseThread(id)
{
    var collapsed = localStorage["collapsed_threads"];
    if (collapsed)
    {
        collapsed = JSON.parse(collapsed);
        var index = collapsed.indexOf(id);
        if (index >= 0)
            collapsed.splice(index, 1);
        localStorage["collapsed_threads"] = JSON.stringify(collapsed);
    }
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse)
{
    if (request.name == "getSettings")
    {
        var tab = sender.tab;
        showPageAction(tab.id, tab.url);
        sendResponse(getSettings());
    }
    else if (request.name == "getUrl")
        getUrl(request.url, sendResponse);
    else if (request.name == "updatePageActionIcons")
        updatePageActionIcons();
    else if (request.name == "collapseThread")
        collapseThread(request.id);
    else if (request.name == "unCollapseThread")
        unCollapseThread(request.id);
    else
        sendResponse();
});
</script>
